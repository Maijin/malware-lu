#!/usr/bin/python
import re, sys
import urllib, urllib2
from cookielib import CookieJar

username="foo"
password="baz"

def main():
	if len(sys.argv) != 2:
		print "%s <md5>" % sys.argv[0]
		sys.exit(1)

	md5 = sys.argv[1]

	url_auth = "http://malware.lu/_auth.php"
	url_download = "http://malware.lu/_download.php"
	url_logout = "http://malware.lu/_logout.php"

	cj = CookieJar()
	opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))

	# Authentification
	params = urllib.urlencode({'username': username, 'password': password})
	f = opener.open(url_auth, params)
	data = f.read()
	if not re.search("<input type=\"text\" name=\"md5\"/>", data):
		print "Error during authentication"
		return

	# Download
	params = urllib.urlencode({'md5': md5})
	f = opener.open(url_download + "?%s" % params)
	headers = f.info()
	if headers['content-type'] == "application/octet-stream":
		filename = re.findall("filename=(\S+)", headers['Content-Disposition'])[0]
		print "Download file %s" % filename
		fp = open(filename, 'w')
		fp.write(f.read())
		fp.close()
	else:
		print "File %s unvailable" % md5

	# Logout
	f = opener.open(url_logout)
	data = f.read()

if __name__ == '__main__':
	main()

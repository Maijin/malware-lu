#!/usr/bin/env python

import sys, os, pefile
from aplib import decompress, compress

def Xor(buffer,EncryptionKey):
    i=0

    for index in range(len(buffer)):
        buffer[index] = buffer[index] ^ int(EncryptionKey[i], 16)

        if i == 3:
        	i=0
        else:
    	   i += 1

def Get_Xor_Key(buffer):
    return [hex(x) for x in buffer[:4]]

def DecompressThisShit(buffer):
    #On bypass les 12 premiers bytes 4 pour la clef xor 4 pour la taille de
    #config compresser 4 pour la taille de la config decompresser

    open("config.raw","wb").write(str(buffer[12:]))

    resource = open("config.raw","rb")
    com=decompress(resource).do()
    os.remove("config.raw")

    print "Config decoded! Save in config.txt."
    print str(com)

    open("config.txt","wb").write(str(com))

def Extract_sdata(pe_file):

    pe = pefile.PE(pe_file)
    peindex=0
    for section in pe.sections:
        if '.sdata' in section.Name:
            data = pe.sections[peindex].get_data(section.VirtualAddress, section.SizeOfRawData)
        peindex = peindex + 1

    return bytearray(data)

resource = Extract_sdata(sys.argv[1])
EncryptionKey = Get_Xor_Key(resource)
print "Xor key: " + str(EncryptionKey)
Xor(resource, EncryptionKey)
DecompressThisShit(resource)
